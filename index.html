<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ORBITAL.LIVE — Every Object Orbiting Earth</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --cyan:#00ffcc;--gold:#ffaa22;--red:#ff4422;--purple:#aa77ff;
  --dim:rgba(0,255,204,0.4);--panel:rgba(2,8,18,0.92);
  --border:rgba(0,255,204,0.18);
}
body{background:#00000a;overflow:hidden;font-family:'Share Tech Mono',monospace;color:var(--cyan);user-select:none;cursor:crosshair}
#canvas{display:block;position:fixed;inset:0;width:100%;height:100%}

/* ── LOADING ────────────────────────────────────────────── */
#loading{position:fixed;inset:0;background:#00000a;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:200;transition:opacity 1s}
#loading.out{opacity:0;pointer-events:none}
.ld-radar{width:120px;height:120px;border:1px solid rgba(0,255,204,0.2);border-radius:50%;position:relative;margin-bottom:32px}
.ld-radar::before{content:'';position:absolute;inset:8px;border:1px solid rgba(0,255,204,0.1);border-radius:50%}
.ld-radar::after{content:'';position:absolute;inset:24px;border:1px solid rgba(0,255,204,0.08);border-radius:50%}
.ld-sweep{position:absolute;inset:0;border-radius:50%;background:conic-gradient(rgba(0,255,204,0.5) 0deg,transparent 60deg);animation:sweep 2s linear infinite}
.ld-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:4px;height:4px;background:var(--cyan);border-radius:50%;box-shadow:0 0 8px var(--cyan)}
@keyframes sweep{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.ld-logo{font-family:'Rajdhani',sans-serif;font-size:1.6rem;font-weight:700;letter-spacing:.3em;color:#fff;margin-bottom:4px}
.ld-logo span{color:var(--cyan)}
.ld-sub{font-size:.65rem;letter-spacing:.25em;color:var(--dim);margin-bottom:28px}
.ld-bar-wrap{width:260px;height:1px;background:rgba(0,255,204,0.1);margin-bottom:10px}
.ld-bar{height:100%;background:linear-gradient(90deg,var(--cyan),#0099ff);width:0%;transition:width .4s;box-shadow:0 0 6px var(--cyan)}
#ldStatus{font-size:.62rem;letter-spacing:.15em;color:rgba(0,255,204,0.35);text-align:center}

/* ── HUD WRAPPER ────────────────────────────────────────── */
#hud{position:fixed;inset:0;pointer-events:none;z-index:10}

/* ── TOP BAR ────────────────────────────────────────────── */
.hud-top{position:absolute;top:0;left:0;right:0;height:52px;background:linear-gradient(to bottom,rgba(0,0,10,.95),transparent);display:flex;align-items:center;padding:0 20px;gap:16px;pointer-events:all;border-bottom:1px solid rgba(0,255,204,0.06)}
.logo{font-family:'Rajdhani',sans-serif;font-size:1.25rem;font-weight:700;color:#fff;letter-spacing:.15em}
.logo span{color:var(--cyan)}
.live{display:flex;align-items:center;gap:5px;font-size:.6rem;letter-spacing:.2em;color:#ff4444;border:1px solid rgba(255,68,68,0.25);padding:3px 8px;border-radius:2px}
.live-dot{width:5px;height:5px;background:#ff4444;border-radius:50%;animation:blink 1.2s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.15}}
.hud-search{flex:1;max-width:220px;position:relative;margin-left:auto}
.hud-search input{width:100%;background:rgba(0,255,204,0.05);border:1px solid rgba(0,255,204,0.15);border-radius:3px;padding:5px 10px 5px 28px;font-family:'Share Tech Mono',monospace;font-size:.7rem;color:var(--cyan);outline:none;letter-spacing:.1em}
.hud-search input::placeholder{color:rgba(0,255,204,0.25)}
.hud-search input:focus{border-color:rgba(0,255,204,0.4)}
.search-icon{position:absolute;left:9px;top:50%;transform:translateY(-50%);font-size:.7rem;color:var(--dim)}
.hud-time{font-size:.78rem;letter-spacing:.12em;color:var(--dim);white-space:nowrap}

/* ── PANELS ─────────────────────────────────────────────── */
.panel{background:var(--panel);border:1px solid var(--border);border-radius:4px;backdrop-filter:blur(8px)}

/* Stats (top-right) */
.stats-panel{position:absolute;top:60px;right:16px;padding:12px 16px;min-width:170px;pointer-events:all}
.stats-title{font-size:.55rem;letter-spacing:.25em;color:rgba(0,255,204,.35);margin-bottom:8px;text-transform:uppercase}
.stat{display:flex;justify-content:space-between;align-items:baseline;gap:16px;padding:3px 0;border-bottom:1px solid rgba(255,255,255,.04)}
.stat:last-child{border-bottom:none}
.sk{font-size:.58rem;color:rgba(0,255,204,.45);letter-spacing:.1em;text-transform:uppercase}
.sv{font-size:.82rem;color:var(--cyan)}

/* Legend (bottom-left) */
.legend-panel{position:absolute;bottom:36px;left:16px;padding:12px 16px;pointer-events:all}
.legend-title{font-size:.55rem;letter-spacing:.25em;color:rgba(0,255,204,.35);margin-bottom:10px}
.leg{display:flex;align-items:center;gap:9px;padding:4px 0;cursor:pointer;transition:opacity .2s}
.leg.off{opacity:.3}
.leg-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.leg-label{font-size:.68rem;letter-spacing:.08em}
.leg-n{margin-left:auto;font-size:.62rem;color:rgba(0,255,204,.4);padding-left:8px}

/* Hint (bottom-right) */
.hint-panel{position:absolute;bottom:36px;right:16px;padding:10px 14px;text-align:right}
.hint-line{font-size:.58rem;letter-spacing:.1em;color:rgba(0,255,204,.25);line-height:2}

/* ── INFO PANEL ─────────────────────────────────────────── */
.info-panel{position:absolute;top:50%;right:16px;transform:translateY(-50%) translateX(310px);transition:transform .4s cubic-bezier(.25,.46,.45,.94);padding:18px 20px;width:270px;pointer-events:all}
.info-panel.open{transform:translateY(-50%) translateX(0)}
.info-close{position:absolute;top:10px;right:10px;background:none;border:none;color:var(--dim);cursor:pointer;font-family:'Share Tech Mono';font-size:.8rem;padding:4px 8px}
.info-close:hover{color:#fff}
.info-cat{font-size:.55rem;letter-spacing:.25em;margin-bottom:5px;text-transform:uppercase}
.info-name{font-family:'Rajdhani',sans-serif;font-size:1.15rem;font-weight:600;color:#fff;line-height:1.2;margin-bottom:14px;padding-right:20px;word-break:break-word}
.irow{display:flex;justify-content:space-between;gap:8px;padding:4px 0;border-bottom:1px solid rgba(255,255,255,.04)}
.irow:last-child{border-bottom:none}
.ik{font-size:.58rem;color:rgba(0,255,204,.4);letter-spacing:.12em;text-transform:uppercase;flex-shrink:0}
.iv{font-size:.72rem;text-align:right;word-break:break-all}

/* ── TOOLTIP ────────────────────────────────────────────── */
#tip{position:fixed;background:rgba(0,5,15,.95);border:1px solid rgba(0,255,204,.2);border-radius:3px;padding:4px 10px;font-size:.68rem;letter-spacing:.08em;pointer-events:none;transform:translate(-50%,-130%);white-space:nowrap;display:none;z-index:30}

/* ── CORNER DECS ────────────────────────────────────────── */
.cr{position:absolute;width:14px;height:14px;border-color:rgba(0,255,204,.25);border-style:solid}
.cr.tl{top:8px;left:8px;border-width:1px 0 0 1px}
.cr.tr{top:8px;right:8px;border-width:1px 1px 0 0}
.cr.bl{bottom:8px;left:8px;border-width:0 0 1px 1px}
.cr.br{bottom:8px;right:8px;border-width:0 1px 1px 0}

/* ── SCAN LINES ─────────────────────────────────────────── */
.scan{position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,.06) 3px,rgba(0,0,0,.06) 4px);pointer-events:none;z-index:5}

/* ── ERROR ──────────────────────────────────────────────── */
#errBox{display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;padding:24px 28px;max-width:380px;pointer-events:all}
.err-t{font-size:.75rem;letter-spacing:.2em;color:#ff4444;margin-bottom:10px}
.err-b{font-size:.68rem;color:rgba(255,150,150,.65);line-height:1.8}

/* ── MOBILE ─────────────────────────────────────────────── */
@media(max-width:640px){
  .stats-panel{display:none}
  .hint-panel{display:none}
  .info-panel{width:calc(100vw - 32px);right:16px;top:auto;bottom:60px;transform:none translateX(0);left:16px}
  .info-panel.open{transform:none}
  .info-panel:not(.open){bottom:-400px}
}
</style>
</head>
<body>

<!-- Loading -->
<div id="loading">
  <div class="ld-radar"><div class="ld-sweep"></div><div class="ld-center"></div></div>
  <div class="ld-logo">ORBITAL<span>.</span>LIVE</div>
  <div class="ld-sub">REAL-TIME EARTH ORBIT TRACKER</div>
  <div class="ld-bar-wrap"><div class="ld-bar" id="ldBar"></div></div>
  <div id="ldStatus">INITIALIZING...</div>
</div>

<!-- Canvas (Three.js target) -->
<canvas id="canvas"></canvas>

<!-- Scanlines -->
<div class="scan"></div>

<!-- Tooltip -->
<div id="tip"></div>

<!-- HUD -->
<div id="hud">
  <div class="cr tl"></div><div class="cr tr"></div>
  <div class="cr bl"></div><div class="cr br"></div>

  <!-- Top bar -->
  <div class="hud-top">
    <div class="logo">ORBITAL<span>.</span>LIVE</div>
    <div class="live"><div class="live-dot"></div>LIVE</div>
    <div class="hud-search">
      <span class="search-icon">⌕</span>
      <input type="text" id="searchBox" placeholder="SEARCH SATELLITE..." oninput="doSearch(this.value)" autocomplete="off">
    </div>
    <div class="hud-time" id="hudTime">UTC —</div>
  </div>

  <!-- Stats -->
  <div class="panel stats-panel">
    <div class="stats-title">Tracking Status</div>
    <div class="stat"><span class="sk">Total Objects</span><span class="sv" id="sTotal">—</span></div>
    <div class="stat"><span class="sk">Payloads</span><span class="sv" id="sPay">—</span></div>
    <div class="stat"><span class="sk">Rocket Bodies</span><span class="sv" id="sRkt">—</span></div>
    <div class="stat"><span class="sk">Debris</span><span class="sv" id="sDeb">—</span></div>
    <div class="stat"><span class="sk">Data Age</span><span class="sv" id="sAge">—</span></div>
  </div>

  <!-- Legend -->
  <div class="panel legend-panel">
    <div class="legend-title">Object Categories</div>
    <div class="leg" id="leg-P" onclick="toggleCat('P')">
      <div class="leg-dot" style="background:#00ffcc;box-shadow:0 0 5px #00ffcc"></div>
      <span class="leg-label">Active Payloads</span>
      <span class="leg-n" id="ln-P">0</span>
    </div>
    <div class="leg" id="leg-R" onclick="toggleCat('R')">
      <div class="leg-dot" style="background:#ffaa22;box-shadow:0 0 5px #ffaa22"></div>
      <span class="leg-label">Rocket Bodies</span>
      <span class="leg-n" id="ln-R">0</span>
    </div>
    <div class="leg" id="leg-D" onclick="toggleCat('D')">
      <div class="leg-dot" style="background:#ff4422;box-shadow:0 0 5px #ff4422"></div>
      <span class="leg-label">Debris</span>
      <span class="leg-n" id="ln-D">0</span>
    </div>
    <div class="leg" id="leg-U" onclick="toggleCat('U')">
      <div class="leg-dot" style="background:#8866aa;box-shadow:0 0 5px #8866aa"></div>
      <span class="leg-label">Unknown</span>
      <span class="leg-n" id="ln-U">0</span>
    </div>
  </div>

  <!-- Hint -->
  <div class="panel hint-panel">
    <div class="hint-line">DRAG — ROTATE</div>
    <div class="hint-line">SCROLL — ZOOM</div>
    <div class="hint-line">CLICK — SELECT</div>
  </div>

  <!-- Info panel -->
  <div class="panel info-panel" id="infoPanel">
    <button class="info-close" onclick="closeInfo()">✕</button>
    <div class="info-cat" id="iCat">PAYLOAD</div>
    <div class="info-name" id="iName">—</div>
    <div class="irow"><span class="ik">NORAD ID</span><span class="iv" id="iId">—</span></div>
    <div class="irow"><span class="ik">Altitude</span><span class="iv" id="iAlt">—</span></div>
    <div class="irow"><span class="ik">Inclination</span><span class="iv" id="iInc">—</span></div>
    <div class="irow"><span class="ik">Orbital Period</span><span class="iv" id="iPer">—</span></div>
    <div class="irow"><span class="ik">Velocity</span><span class="iv" id="iVel">—</span></div>
    <div class="irow"><span class="ik">Country</span><span class="iv" id="iCtry">—</span></div>
    <div class="irow"><span class="ik">Launch</span><span class="iv" id="iLaunch">—</span></div>
    <div class="irow"><span class="ik">Int'l Desig.</span><span class="iv" id="iIntl">—</span></div>
  </div>

  <!-- Error box -->
  <div class="panel" id="errBox">
    <div class="err-t">⚠ DATA CONNECTION FAILED</div>
    <div class="err-b" id="errMsg">Could not reach CelesTrak API. Try hosting the file on a web server (GitHub Pages, etc.) rather than opening it directly as a local file.</div>
  </div>
</div>

<!-- Three.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
'use strict';

// ════════════════════════════════════════════════════════════════
//  CONSTANTS
// ════════════════════════════════════════════════════════════════
const ER   = 6.371;          // Earth radius in Three.js units (1 unit = 1000 km)
const MU   = 3.986004418e5;  // km³/s²  (gravitational parameter)
const J2K  = 946728000000;   // ms — J2000.0 epoch (Jan 1.5, 2000 UTC)

// Category keys and display colours
const CATS = {
  P: { label:'PAYLOAD',      color:0x00ffcc, size:3.5, opacity:1.0  },
  R: { label:'ROCKET BODY',  color:0xffaa22, size:2.5, opacity:0.9  },
  D: { label:'DEBRIS',       color:0xff4422, size:1.6, opacity:0.55 },
  U: { label:'UNKNOWN',      color:0x8866aa, size:2.0, opacity:0.65 }
};

// Map CelesTrak OBJECT_TYPE string → internal key
function typeKey(t){
  if(!t) return 'U';
  t = t.toUpperCase().trim();
  if(t==='PAYLOAD')      return 'P';
  if(t==='ROCKET BODY')  return 'R';
  if(t==='DEBRIS')       return 'D';
  return 'U';
}

// ════════════════════════════════════════════════════════════════
//  THREE.JS RENDERER + CAMERA
// ════════════════════════════════════════════════════════════════
const canvas  = document.getElementById('canvas');
const renderer= new THREE.WebGLRenderer({canvas, antialias:true});
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setClearColor(0x00000a, 1);

const scene = new THREE.Scene();
const camera= new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.01, 800);

// Spherical camera state
let sph = { theta:0.3, phi:1.25, r:40 };
let autoRot = true;

function moveCam(){
  camera.position.set(
    sph.r * Math.sin(sph.phi) * Math.sin(sph.theta),
    sph.r * Math.cos(sph.phi),
    sph.r * Math.sin(sph.phi) * Math.cos(sph.theta)
  );
  camera.lookAt(0,0,0);
}
moveCam();

window.addEventListener('resize', ()=>{
  renderer.setSize(window.innerWidth, window.innerHeight);
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
});

// ════════════════════════════════════════════════════════════════
//  SCENE OBJECTS
// ════════════════════════════════════════════════════════════════

// --- Stars ---
(function(){
  const n=10000, pos=new Float32Array(n*3), col=new Float32Array(n*3);
  for(let i=0;i<n;i++){
    const a=Math.random()*2*Math.PI, b=Math.acos(2*Math.random()-1);
    const r=380+Math.random()*80;
    pos[i*3]  =r*Math.sin(b)*Math.cos(a);
    pos[i*3+1]=r*Math.cos(b);
    pos[i*3+2]=r*Math.sin(b)*Math.sin(a);
    const br=0.3+Math.random()*0.7;
    col[i*3]=br; col[i*3+1]=br; col[i*3+2]=Math.min(1,br+0.15);
  }
  const g=new THREE.BufferGeometry();
  g.setAttribute('position', new THREE.BufferAttribute(pos,3));
  g.setAttribute('color',    new THREE.BufferAttribute(col,3));
  scene.add(new THREE.Points(g, new THREE.PointsMaterial({size:.6,vertexColors:true,sizeAttenuation:false})));
})();

// --- Earth ---
(function(){
  const g=new THREE.SphereGeometry(ER,64,64);
  // Phong with deep ocean tones
  const m=new THREE.MeshPhongMaterial({
    color:0x040f1c, emissive:0x020a14,
    specular:0x1a4060, shininess:18
  });
  scene.add(new THREE.Mesh(g,m));

  // Thin atmosphere rim
  const ag=new THREE.SphereGeometry(ER+0.14,48,32);
  const am=new THREE.MeshPhongMaterial({
    color:0x2266aa, transparent:true, opacity:.1,
    side:THREE.FrontSide, blending:THREE.AdditiveBlending, depthWrite:false
  });
  scene.add(new THREE.Mesh(ag,am));

  // Back-glow
  const bg=new THREE.SphereGeometry(ER+0.55,32,16);
  const bm=new THREE.MeshPhongMaterial({
    color:0x0044aa, transparent:true, opacity:.04,
    side:THREE.BackSide, blending:THREE.AdditiveBlending, depthWrite:false
  });
  scene.add(new THREE.Mesh(bg,bm));
})();

// --- Grid lines ---
(function(){
  const r=ER+0.006;
  const gMat=new THREE.LineBasicMaterial({color:0x003344,transparent:true,opacity:.4,depthWrite:false});
  const eMat=new THREE.LineBasicMaterial({color:0x005566,transparent:true,opacity:.65,depthWrite:false});

  // Latitude rings every 30°
  for(let lat=-90;lat<=90;lat+=30){
    const phi=lat*Math.PI/180, y=r*Math.sin(phi), rxy=r*Math.cos(phi);
    const pts=[];
    for(let lon=0;lon<=360;lon+=3){
      const th=lon*Math.PI/180;
      pts.push(new THREE.Vector3(rxy*Math.sin(th), y, rxy*Math.cos(th)));
    }
    scene.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints(pts), lat===0?eMat:gMat));
  }

  // Longitude lines every 30°
  for(let lon=0;lon<360;lon+=30){
    const th=lon*Math.PI/180, pts=[];
    for(let lat=-90;lat<=90;lat+=2){
      const phi=lat*Math.PI/180, rxy=r*Math.cos(phi);
      pts.push(new THREE.Vector3(rxy*Math.sin(th), r*Math.sin(phi), rxy*Math.cos(th)));
    }
    scene.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints(pts), gMat));
  }
})();

// --- Lighting ---
scene.add(new THREE.AmbientLight(0x112233, 1.5));
const sun=new THREE.DirectionalLight(0xffffff, 0.7);
sun.position.set(100,40,60); scene.add(sun);

// --- Glow dot texture ---
const glowTex=(function(){
  const c=document.createElement('canvas');
  c.width=c.height=64;
  const ctx=c.getContext('2d');
  const g=ctx.createRadialGradient(32,32,0,32,32,32);
  g.addColorStop(0,'rgba(255,255,255,1)');
  g.addColorStop(.2,'rgba(255,255,255,.85)');
  g.addColorStop(.5,'rgba(255,255,255,.25)');
  g.addColorStop(1,'rgba(255,255,255,0)');
  ctx.fillStyle=g; ctx.fillRect(0,0,64,64);
  return new THREE.CanvasTexture(c);
})();

// --- Selection ring ---
const selRingMat = new THREE.MeshBasicMaterial({
  color:0xffffff, transparent:true, opacity:.85,
  side:THREE.DoubleSide, blending:THREE.AdditiveBlending, depthWrite:false
});
const selRing = new THREE.Mesh(
  new THREE.RingGeometry(.18,.22,48),
  selRingMat
);
selRing.visible=false;
scene.add(selRing);

// ISS orbit ring (shown when ISS selected)
const issOrbitMat=new THREE.LineBasicMaterial({color:0xffffff,transparent:true,opacity:.2,depthWrite:false});
const issOrbitLine=new THREE.Line(new THREE.BufferGeometry(),issOrbitMat);
issOrbitLine.visible=false;
scene.add(issOrbitLine);

// ════════════════════════════════════════════════════════════════
//  SATELLITE DATA STORE
// ════════════════════════════════════════════════════════════════
let sats=[];            // all satellite objects
let catClouds={};       // {key: {points, buf, arr}}
let catSats={P:[],R:[],D:[],U:[]};
let catVis={P:true,R:true,D:true,U:true};
let selSat=null;
let searchHits=new Set();
let isSearching=false;

// ════════════════════════════════════════════════════════════════
//  KEPLERIAN PROPAGATOR
//  ECI → ECEF → Three.js (Y=north pole up, Z=prime meridian)
// ════════════════════════════════════════════════════════════════
function propagate(sat, dateMs){
  try{
    const n  = sat.mm * 2*Math.PI / 86400;  // rad/s
    const a  = Math.cbrt(MU/(n*n));          // km, semi-major axis
    const e  = sat.e;
    const dt = (dateMs - sat.epochMs) / 1000; // seconds

    // Mean anomaly
    let M = sat.M0 + n*dt;
    M = ((M % (2*Math.PI)) + 2*Math.PI) % (2*Math.PI);

    // Eccentric anomaly (Newton-Raphson, 8 iters)
    let E=M;
    for(let k=0;k<8;k++){
      const dE=(E - e*Math.sin(E) - M)/(1 - e*Math.cos(E));
      E-=dE;
      if(Math.abs(dE)<1e-10) break;
    }

    // True anomaly
    const nu=2*Math.atan2(Math.sqrt(1+e)*Math.sin(E/2), Math.sqrt(1-e)*Math.cos(E/2));
    const r=a*(1 - e*Math.cos(E)); // km

    // Perifocal position
    const xp=r*Math.cos(nu), yp=r*Math.sin(nu);

    // Rotation: perifocal → ECI
    const cO=sat.cRAAN, sO=sat.sRAAN;
    const ci=sat.ci,    si=sat.si;
    const cw=sat.cAOP,  sw=sat.sAOP;
    const EX=(cO*cw - sO*sw*ci)*xp + (-cO*sw - sO*cw*ci)*yp;
    const EY=(sO*cw + cO*sw*ci)*xp + (-sO*sw + cO*cw*ci)*yp;
    const EZ=(si*sw)*xp + (si*cw)*yp;

    // GMST → ECI to ECEF
    const dJ = (dateMs - J2K) / 86400000;
    const G  = ((280.46061837 + 360.98564736629*dJ) % 360) * Math.PI/180;
    const cG=Math.cos(G), sG=Math.sin(G);
    const Xe=EX*cG + EY*sG;
    const Ye=-EX*sG + EY*cG;
    const Ze=EZ;

    // ECEF → Three.js  (threeX=Ye, threeY=Ze, threeZ=Xe)
    const s=1/1000;
    return { x:Ye*s, y:Ze*s, z:Xe*s,
             alt: r-6371,           // km above surface
             vel: Math.sqrt(MU/a),  // km/s
             per: 86400/sat.mm,     // seconds
             r };
  }catch(_){ return null; }
}

function parseSat(gp){
  const inc=parseFloat(gp.INCLINATION)||0;
  const raan=parseFloat(gp.RA_OF_ASC_NODE)||0;
  const aop=parseFloat(gp.ARG_OF_PERICENTER)||0;
  const ma=parseFloat(gp.MEAN_ANOMALY)||0;
  const ir=inc*Math.PI/180, rr=raan*Math.PI/180, ar=aop*Math.PI/180;

  // Parse epoch
  let ep=gp.EPOCH||'';
  if(!ep.endsWith('Z')) ep+='Z';
  const epochMs=new Date(ep).getTime();

  return {
    name:    gp.OBJECT_NAME || '—',
    id:      parseInt(gp.NORAD_CAT_ID)||0,
    intl:    gp.OBJECT_ID||'—',
    country: gp.COUNTRY_CODE||'—',
    launch:  gp.LAUNCH_DATE||'—',
    type:    typeKey(gp.OBJECT_TYPE),
    epochMs,
    mm:   parseFloat(gp.MEAN_MOTION)||0,
    e:    parseFloat(gp.ECCENTRICITY)||0,
    M0:   ma*Math.PI/180,
    inc:  inc,
    // precomputed trig for perf
    cRAAN: Math.cos(rr), sRAAN: Math.sin(rr),
    ci:    Math.cos(ir), si:    Math.sin(ir),
    cAOP:  Math.cos(ar), sAOP:  Math.sin(ar)
  };
}

// ════════════════════════════════════════════════════════════════
//  POINT CLOUDS
// ════════════════════════════════════════════════════════════════
function buildClouds(byKey){
  Object.entries(byKey).forEach(([k, arr])=>{
    if(!arr.length) return;
    const cfg=CATS[k];
    const pos=new Float32Array(arr.length*3);
    const geo=new THREE.BufferGeometry();
    geo.setAttribute('position', new THREE.BufferAttribute(pos,3));
    const mat=new THREE.PointsMaterial({
      color:cfg.color, size:cfg.size, map:glowTex,
      transparent:true, opacity:cfg.opacity,
      sizeAttenuation:false,
      blending:THREE.AdditiveBlending,
      depthWrite:false, alphaTest:.01
    });
    const points=new THREE.Points(geo,mat);
    scene.add(points);
    catClouds[k]={points, pos, arr};
  });
}

function updateAllPositions(dateMs){
  Object.entries(catClouds).forEach(([k,cloud])=>{
    cloud.points.visible = catVis[k];
    if(!cloud.points.visible) return;
    const {arr,pos}=cloud;
    for(let i=0;i<arr.length;i++){
      const p=propagate(arr[i], dateMs);
      if(p){ pos[i*3]=p.x; pos[i*3+1]=p.y; pos[i*3+2]=p.z; }
      else { pos[i*3]=0; pos[i*3+1]=0; pos[i*3+2]=0; }
    }
    cloud.points.geometry.attributes.position.needsUpdate=true;
  });
}

// ════════════════════════════════════════════════════════════════
//  DATA LOADING
// ════════════════════════════════════════════════════════════════
function setLoad(pct, msg){
  document.getElementById('ldBar').style.width=pct+'%';
  document.getElementById('ldStatus').textContent=msg;
}

async function fetchData(url){
  const r=await fetch(url,{mode:'cors',cache:'no-cache'});
  if(!r.ok) throw new Error('HTTP '+r.status);
  return r.json();
}

async function loadSatellites(){
  // Hardwired internal path. The dot-slash means "look in the current folder"
  const primaryUrl = './active.json'; 

  setLoad(10,'LOADING LOCAL TELEMETRY...');

  let data=null;
  const attempts=[
    {url: primaryUrl, label: 'LOCAL DATA'}
  ];

  for(const {url,label} of attempts){
    try{
      setLoad(20,`TRYING ${label}...`);
      data=await fetchData(url);
      if(Array.isArray(data)&&data.length>0) break;
    }catch(e){
      console.warn(label,'failed:',e.message);
      data=null;
    }
  }

if(!data||!Array.isArray(data)){
    showError('Telemetry offline. Ensure active.json is uploaded to the exact same GitHub folder as this file, and ensure the file is not accidentally named active.json.txt.');
    return;
  }

  setLoad(55,`PARSING ${data.length.toLocaleString()} OBJECTS...`);
  await tick();

  // Parse & bucket
  const byKey={P:[],R:[],D:[],U:[]};
  data.forEach(gp=>{
    const s=parseSat(gp);
    if(s.mm>0.5 && s.epochMs && !isNaN(s.epochMs)){
      byKey[s.type].push(s);
      sats.push(s);
    }
  });
  catSats=byKey;

  setLoad(75,'BUILDING 3D VISUALISATION...');
  await tick();
  buildClouds(byKey);

  // UI counts
  let total=0;
  Object.entries(byKey).forEach(([k,a])=>{
    const el=document.getElementById('ln-'+k);
    if(el) el.textContent=a.length.toLocaleString();
    total+=a.length;
  });
  setById('sTotal', total.toLocaleString());
  setById('sPay',   byKey.P.length.toLocaleString());
  setById('sRkt',   byKey.R.length.toLocaleString());
  setById('sDeb',   byKey.D.length.toLocaleString());
  // Data age
  if(sats.length){
    const ages=sats.map(s=>s.epochMs).filter(Boolean);
    const newest=new Date(Math.max(...ages));
    setById('sAge', newest.toISOString().slice(0,10));
  }

  setLoad(90,'COMPUTING ORBITAL POSITIONS...');
  await tick();
  updateAllPositions(Date.now());

  setLoad(100,'TRACKING ONLINE');
  await tick(600);
  document.getElementById('loading').classList.add('out');
  setTimeout(()=>{const l=document.getElementById('loading'); if(l) l.remove();},1100);
}

function showError(msg){
  document.getElementById('errMsg').textContent=msg;
  document.getElementById('errBox').style.display='block';
  setLoad(100,'CONNECTION FAILED');
  document.getElementById('ldBar').style.background='#ff4422';
  setTimeout(()=>{
    document.getElementById('loading').classList.add('out');
  },1500);
}

function tick(ms=0){ return new Promise(r=>setTimeout(r,ms)); }
function setById(id,v){ const e=document.getElementById(id); if(e) e.textContent=v; }

// ════════════════════════════════════════════════════════════════
//  SELECTION & INTERACTION
// ════════════════════════════════════════════════════════════════
const raycaster=new THREE.Raycaster();
raycaster.params.Points.threshold=0.35;

let isDrag=false, dragStart={x:0,y:0}, prevSph={...sph};

canvas.addEventListener('mousedown',e=>{
  isDrag=true; dragStart={x:e.clientX,y:e.clientY}; prevSph={...sph};
  autoRot=false;
});
window.addEventListener('mouseup',e=>{
  if(isDrag){
    if(Math.abs(e.clientX-dragStart.x)<5 && Math.abs(e.clientY-dragStart.y)<5)
      doClick(e.clientX,e.clientY);
  }
  isDrag=false;
});
window.addEventListener('mousemove',e=>{
  if(!isDrag) return;
  const dx=e.clientX-dragStart.x, dy=e.clientY-dragStart.y;
  sph.theta=prevSph.theta - dx*.006;
  sph.phi=Math.max(.05, Math.min(Math.PI-.05, prevSph.phi - dy*.006));
  moveCam();
});
canvas.addEventListener('wheel',e=>{
  e.preventDefault();
  sph.r=Math.max(7.5, Math.min(95, sph.r + e.deltaY*.04));
  moveCam();
},{passive:false});

// Touch
let tStart=null, tSph=null;
canvas.addEventListener('touchstart',e=>{
  if(e.touches.length===1){tStart={x:e.touches[0].clientX,y:e.touches[0].clientY};tSph={...sph};autoRot=false;}
},{passive:true});
canvas.addEventListener('touchmove',e=>{
  if(e.touches.length===1&&tStart){
    sph.theta=tSph.theta-(e.touches[0].clientX-tStart.x)*.006;
    sph.phi=Math.max(.05,Math.min(Math.PI-.05,tSph.phi-(e.touches[0].clientY-tStart.y)*.006));
    moveCam();
  }
  e.preventDefault();
},{passive:false});
canvas.addEventListener('touchend',e=>{
  if(tStart){
    const t=e.changedTouches[0];
    if(Math.abs(t.clientX-tStart.x)<12&&Math.abs(t.clientY-tStart.y)<12)
      doClick(t.clientX,t.clientY);
  }
  tStart=null;
});

function doClick(mx,my){
  const mouse=new THREE.Vector2((mx/window.innerWidth)*2-1, -(my/window.innerHeight)*2+1);
  raycaster.setFromCamera(mouse,camera);

  let best=null, bestD=Infinity, bestIdx=-1, bestCat=null;
  Object.entries(catClouds).forEach(([k,cloud])=>{
    if(!cloud.points.visible) return;
    const hits=raycaster.intersectObject(cloud.points);
    if(hits.length){
      const d=hits[0].distanceToRay ?? hits[0].distance;
      if(d<bestD){ bestD=d; bestIdx=hits[0].index; bestCat=k; best=cloud.arr[bestIdx]; }
    }
  });
  if(best) openInfo(best, bestCat);
  else closeInfo();
}

function openInfo(sat, catKey){
  selSat=sat;
  const p=propagate(sat, Date.now());
  const catCfg=CATS[catKey]||CATS['U'];
  const col='#'+catCfg.color.toString(16).padStart(6,'0');

  document.getElementById('iCat').textContent=catCfg.label;
  document.getElementById('iCat').style.color=col;
  document.getElementById('iName').textContent=sat.name;
  setById('iId',    sat.id);
  setById('iAlt',   p ? Math.round(p.alt).toLocaleString()+' km' : '—');
  setById('iInc',   sat.inc.toFixed(2)+'°');
  setById('iPer',   p ? (p.per/60).toFixed(1)+' min' : '—');
  setById('iVel',   p ? p.vel.toFixed(2)+' km/s' : '—');
  setById('iCtry',  sat.country);
  setById('iLaunch',sat.launch);
  setById('iIntl',  sat.intl);

  document.getElementById('infoPanel').classList.add('open');

  // Draw ISS orbit preview if it's the ISS
  if(sat.id===25544) drawOrbitLine(sat);
  else issOrbitLine.visible=false;
}

function closeInfo(){
  document.getElementById('infoPanel').classList.remove('open');
  selSat=null; selRing.visible=false; issOrbitLine.visible=false;
}

function drawOrbitLine(sat){
  const pts=[], steps=180, now=Date.now(), per=sat.mm>0?86400000/sat.mm:0;
  for(let i=0;i<=steps;i++){
    const t=now+(per/steps)*i;
    const p=propagate(sat,t);
    if(p) pts.push(new THREE.Vector3(p.x,p.y,p.z));
  }
  issOrbitLine.geometry.setFromPoints(pts);
  issOrbitLine.visible=true;
}

// ════════════════════════════════════════════════════════════════
//  CATEGORY TOGGLE
// ════════════════════════════════════════════════════════════════
function toggleCat(k){
  catVis[k]=!catVis[k];
  document.getElementById('leg-'+k).classList.toggle('off',!catVis[k]);
  if(catClouds[k]) catClouds[k].points.visible=catVis[k];
}

// ════════════════════════════════════════════════════════════════
//  SEARCH
// ════════════════════════════════════════════════════════════════
function doSearch(q){
  q=q.trim().toUpperCase();
  if(!q){ isSearching=false; searchHits.clear(); resetOpacity(); return; }
  isSearching=true;
  searchHits.clear();

  sats.forEach((s,i)=>{
    if(s.name.includes(q) || String(s.id).includes(q)) searchHits.add(i);
  });

  // If exactly one hit, open info
  const hits=sats.filter((s,i)=>searchHits.has(i));
  if(hits.length===1) openInfo(hits[0], hits[0].type);

  applySearchOpacity();
}

function applySearchOpacity(){
  if(!isSearching){ resetOpacity(); return; }
  // dim all cats, then re-enable matched indices using vertex alpha
  // Simple approach: hide non-matching categories via opacity
  // For per-point filtering we'd need custom shaders; instead dim globally
  Object.entries(catClouds).forEach(([k,cloud])=>{
    const base=CATS[k].opacity;
    cloud.points.material.opacity = isSearching ? base*.15 : base;
  });
}

function resetOpacity(){
  Object.entries(catClouds).forEach(([k,cloud])=>{
    cloud.points.material.opacity=CATS[k].opacity;
  });
}

// ════════════════════════════════════════════════════════════════
//  CLOCK
// ════════════════════════════════════════════════════════════════
function updateClock(){
  const n=new Date();
  const pad=v=>String(v).padStart(2,'0');
  document.getElementById('hudTime').textContent=
    `UTC ${pad(n.getUTCHours())}:${pad(n.getUTCMinutes())}:${pad(n.getUTCSeconds())}`;
}

// ════════════════════════════════════════════════════════════════
//  ANIMATION LOOP
// ════════════════════════════════════════════════════════════════
let lastUpdate=0, lastClock=0;

function animate(ts){
  requestAnimationFrame(animate);

  // Gentle auto-rotate
  if(autoRot){ sph.theta+=0.00035; moveCam(); }

  // Update orbital positions every 2 s
  if(ts-lastUpdate > 2000){
    const now=Date.now();
    updateAllPositions(now);
    lastUpdate=ts;

    // Live-update selected satellite info
    if(selSat){
      const p=propagate(selSat,now);
      if(p){
        setById('iAlt', Math.round(p.alt).toLocaleString()+' km');
        setById('iVel', p.vel.toFixed(2)+' km/s');
        // Move selection ring
        selRing.position.set(p.x,p.y,p.z);
        selRing.lookAt(camera.position);
        selRing.visible=true;
        const pulse=0.85+0.15*Math.sin(ts*.0025);
        selRing.scale.setScalar(pulse);
      }
    }
  }

  // Update clock every second
  if(ts-lastClock > 1000){ updateClock(); lastClock=ts; }

  renderer.render(scene,camera);
}

// ════════════════════════════════════════════════════════════════
//  BOOT
// ════════════════════════════════════════════════════════════════
loadSatellites();
animate(0);
</script>
</body>
</html>
